<% car ||= @car %>

<% if flash[:notice] %>
  <div id="flash-notice" class="flash-message flash-notice">
    <strong>Success:</strong> <%= flash[:notice] %>
  </div>
<% elsif flash[:alert] %>
  <div id="flash-alert" class="flash-message flash-alert">
    <strong>Error:</strong> <%= flash[:alert] %>
  </div>
<% end %>

<div class="car-form-wrapper">
  <h1><%= car.new_record? ? "Add Car" : "Edit Car" %></h1>

  <%= form_with(model: car, local: true, html: { multipart: true }) do |form| %>
    <% if car.errors.any? %>
      <div class="flash-message flash-alert">
        <strong><%= pluralize(car.errors.count, "error") %> prevented this car from being saved:</strong>
        <ul>
          <% car.errors.each do |error| %>
            <li><%= error.full_message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <!-- Basic Info -->
    <div class="form-group">
      <%= form.label :make %>
      <%= form.text_field :make %>
    </div>

    <div class="form-group">
      <%= form.label :model %>
      <%= form.text_field :model %>
    </div>

    <div class="form-group">
      <%= form.label :year %>
      <%= form.number_field :year %>
    </div>

    <div class="form-group">
      <%= form.label :price, "Price (KES)" %>
      <%= form.number_field :price, step: 50 %>
    </div>

    <!-- Specs -->
    <div class="form-group">
      <%= form.label :transmission_type %>
      <%= form.select :transmission_type, ["Automatic", "Manual"], prompt: "Select transmission type" %>
    </div>

    <div class="form-group">
      <%= form.label :fuel_type %>
      <%= form.select :fuel_type, ["Petrol", "Diesel", "Electric", "Hybrid"], prompt: "Select fuel type" %>
    </div>

    <div class="form-group">
      <%= form.label :insurance_status %>
      <%= form.select :insurance_status, ["Fully insured", "Third-party", "Not insured"], prompt: "Select insurance status" %>
    </div>

    <div class="form-group">
      <%= form.label :seats, "Number of Seats" %>
      <%= form.number_field :seats, min: 1, max: 100, step: 1, placeholder: "e.g. 5" %>
    </div>

    <!-- Listing Type -->
    <div class="form-group">
      <%= form.label :listing_type %>
      <div class="radio-group">
        <% Car::LISTING_TYPES.each do |type| %>
          <label>
            <%= form.radio_button :listing_type, type %>
            <span><%= type.titleize %></span>
          </label>
        <% end %>
      </div>
    </div>

    <div class="form-group">
      <%= form.label :deposit_amount, "Security Deposit (KES)" %>
      <%= form.number_field :deposit_amount, step: 50, min: 0 %>
    </div>

    <!-- Description -->
    <div class="form-group">
      <%= form.label :description %>
      <%= form.text_area :description, rows: 4 %>
    </div>

    <!-- Existing Images -->
    <% if car.persisted? && car.car_images.any? %>
      <label class="form-group">Current Images</label>
      <div id="sortable-images"
           class="image-preview"
           data-controller="car-form"
           data-car-form-reorder-url-value="<%= reorder_car_car_images_path(car) %>">

        <% car.car_images.each do |img| %>
          <div class="sortable-item" data-id="<%= img.id %>">
            <div class="drag-handle">â˜°</div>
            <%= image_tag img.image_url %>
            <div class="image-actions">
              <% if img.cover? %>
                <span class="cover-label">Cover âœ“</span>
              <% else %>
                <a href="#"
                   class="cover-link"
                   data-action="car-form#setCover"
                   data-url="<%= set_cover_car_car_image_path(car, img) %>">
                   Make Cover
                </a>
              <% end %>
              <a href="#"
                 class="delete-link"
                 data-action="car-form#confirmDelete"
                 data-url="<%= car_car_image_path(car, img) %>">
                 ðŸ—‘ Delete
              </a>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Upload New Images -->
    <div class="form-group">
      <%= form.label :images, "Upload Car Images" %>
      <%= form.file_field :images, multiple: true, accept: "image/*" %>
      <p class="hint">You can select multiple files. Accepted formats: JPG, PNG.</p>
      <div id="preview-area" class="image-preview"></div>
    </div>

    <!-- Location -->
    <div class="form-group">
      <%= form.label :pickup_address %>
      <%= form.text_field :pickup_address %>
    </div>

    <div class="form-group">
      <%= form.label :latitude %>
      <%= form.text_field :latitude %>
    </div>

    <div class="form-group">
      <%= form.label :longitude %>
      <%= form.text_field :longitude %>
    </div>

    <!-- Category -->
    <div class="form-group">
      <%= form.label :category %>
      <%= form.select :category, ['SUV', 'Sedan', 'Hatchback', 'Truck', 'Van', 'Luxury', 'Convertible', 'Electric Car', 'Other'], { prompt: 'Select a category' } %>
    </div>

    <!-- Buttons -->
    <div class="button-group">
      <%= form.submit "Save as Draft", name: "draft", class: "button-secondary" %>
      <%= form.submit "Publish", name: "publish", class: "button-primary" %>
    </div>
  <% end %>
</div>
