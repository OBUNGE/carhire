<% if flash[:notice] %>
  <div class="form-group flash-message" id="flash-notice" style="background:#e6ffed; border:1px solid #a7f3d0; color:#065f46; padding:12px; border-radius:6px;">
    <strong>Success:</strong> <%= flash[:notice] %>
  </div>
<% elsif flash[:alert] %>
  <div class="form-group flash-message" id="flash-alert" style="background:#fef2f2; border:1px solid #fca5a5; color:#991b1b; padding:12px; border-radius:6px;">
    <strong>Error:</strong> <%= flash[:alert] %>
  </div>
<% end %>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const flashNotice = document.getElementById("flash-notice");
  const flashAlert = document.getElementById("flash-alert");

  [flashNotice, flashAlert].forEach((el) => {
    if (el) {
      setTimeout(() => {
        el.style.transition = "opacity 0.5s ease-out";
        el.style.opacity = "0";
        setTimeout(() => el.remove(), 500);
      }, 4000);
    }
  });
});
</script>

<div class="car-form-wrapper">
  <h1><%= car.new_record? ? "Add Car" : "Edit Car" %></h1>

  <%= form_with(model: car, local: true, html: { multipart: true }) do |form| %>
    <% if car.errors.any? %>
      <div class="form-group" style="background:#fef2f2; border:1px solid #fca5a5; color:#991b1b; padding:12px; border-radius:6px;">
        <strong><%= pluralize(car.errors.count, "error") %> prevented this car from being saved:</strong>
        <ul>
          <% car.errors.each do |error| %>
            <li><%= error.full_message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <!-- Basic Info -->
    <div class="form-group">
      <%= form.label :make %>
      <%= form.text_field :make %>
    </div>

    <div class="form-group">
      <%= form.label :model %>
      <%= form.text_field :model %>
    </div>

    <div class="form-group">
      <%= form.label :year %>
      <%= form.number_field :year %>
    </div>

    <div class="form-group">
      <%= form.label :price, "Price (KES)" %>
      <%= form.number_field :price, step: 50 %>
    </div>

    <!-- Specs -->
    <div class="form-group">
      <%= form.label :transmission_type %>
      <%= form.select :transmission_type, ["Automatic", "Manual"], prompt: "Select transmission type" %>
    </div>

    <div class="form-group">
      <%= form.label :fuel_type %>
      <%= form.select :fuel_type, ["Petrol", "Diesel", "Electric", "Hybrid"], prompt: "Select fuel type" %>
    </div>

    <div class="form-group">
      <%= form.label :insurance_status %>
      <%= form.select :insurance_status, ["Fully insured", "Third-party", "Not insured"], prompt: "Select insurance status" %>
    </div>

    <div class="form-group">
      <%= form.label :seats, "Number of Seats" %>
      <%= form.number_field :seats, min: 1, max: 100, step: 1, placeholder: "e.g. 5" %>
    </div>

    <!-- Listing Type -->
    <div class="form-group">
      <%= form.label :listing_type %>
      <div class="radio-group">
        <% Car::LISTING_TYPES.each do |type| %>
          <label>
            <%= form.radio_button :listing_type, type %>
            <%= type.titleize %>
          </label>
        <% end %>
      </div>
    </div>

    <div class="form-group">
      <%= form.label :deposit_amount, "Security Deposit (KES)" %>
      <%= form.number_field :deposit_amount, step: 50, min: 0 %>
    </div>

    <!-- Description -->
    <div class="form-group">
      <%= form.label :description %>
      <%= form.text_area :description, rows: 4 %>
    </div>

    <!-- Existing Images -->
    <% if car.persisted? && car.car_images.any? %>
      <div class="form-group">
        <label>Current Images</label>
        <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(140px, 1fr)); gap:12px;">
          <% car.car_images.each do |img| %>
            <div style="position:relative; border:1px solid #eee; border-radius:6px; padding:8px;">
              <%= image_tag img.image_url, style: "width:100%; border-radius:4px;" %>

              <div style="margin-top:6px; display:flex; justify-content:space-between; align-items:center;">
                <% if img.cover? %>
                  <span style="font-size:0.875rem; color:green;">Cover âœ“</span>
                <% else %>
                  <%= link_to "Set as cover", set_cover_car_car_image_path(car, img),
                              method: :patch, class: "btn btn-sm btn-outline-primary" %>
                <% end %>

                <%= link_to "Delete", car_car_image_path(car, img),
                            method: :delete,
                            data: { confirm: "Are you sure you want to delete this image?" },
                            class: "btn btn-sm btn-outline-danger" %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Upload New Images -->
    <div class="form-group">
      <%= form.label :images, "Upload Car Images" %>
      <%= form.file_field :images, multiple: true, accept: "image/*" %>
      <p style="font-size:0.875rem; color:#555;">You can select multiple files. Accepted formats: JPG, PNG.</p>
    </div>

    <!-- Location -->
    <div class="form-group">
      <%= form.label :pickup_address %>
      <%= form.text_field :pickup_address %>
    </div>

    <div class="form-group">
      <%= form.label :latitude %>
      <%= form.text_field :latitude %>
    </div>

    <div class="form-group">
      <%= form.label :longitude %>
      <%= form.text_field :longitude %>
    </div>

    <!-- Category -->
    <div class="form-group">
      <%= form.label :category %>
      <%= form.select :category, [
          'SUV', 'Sedan', 'Hatchback', 'Truck', 'Van', 'Luxury', 'Convertible', 'Electric Car', 'Other'
        ], { prompt: 'Select a category' } %>
    </div>

    <!-- Buttons -->
    <div class="button-group">
      <%= form.submit "Save as Draft", name: "draft", class: "button-secondary" %>
      <%= form.submit "Publish", name: "publish", class: "button-primary" %>
    </div>
  <% end %>
</div>
