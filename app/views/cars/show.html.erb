<% content_for :title, "Showing car" %>
<% if @car.status == "draft" %>
  <div style="background:#fef2f2; border:1px solid #fca5a5; color:#991b1b; padding:10px; border-radius:6px; margin-bottom:16px;">
    <strong>Status:</strong> This car is saved as <em>draft</em>. Only you can see it.
  </div>
<% elsif @car.status == "published" %>
  <div style="background:#e6ffed; border:1px solid #a7f3d0; color:#065f46; padding:10px; border-radius:6px; margin-bottom:16px;">
    <strong>Status:</strong> This car is <em>published</em> and visible to renters.
  </div>
<% end %>


<div style="display:flex; flex-wrap:wrap; gap:20px; margin-top:20px;">
  <!-- LEFT: Image Gallery -->
  <div style="flex:1 1 60%; min-width:300px; position:relative;">
    <% if @car.images.attached? %>
      <div style="position:relative; width:100%; height:80vh; border-radius:16px; overflow:hidden; box-shadow:0 4px 15px rgba(0,0,0,0.2);">
        <%= image_tag @car.images.first.variant(resize_to_limit: [1600,1600]),
            id:"mainImage",
            style:"width:100%; height:100%; object-fit:cover; transition:0.4s ease;" %>

        <!-- Overlay Title -->
        <div style="position:absolute; top:20px; left:20px; background:rgba(0,0,0,0.6); color:white; padding:10px 16px; border-radius:8px; font-size:20px; font-weight:600;">
          <%= @car.make %> <%= @car.model %>
        </div>

        <!-- Prev Button -->
        <button onclick="showPrevImage()" 
                style="position:absolute; top:50%; left:15px; transform:translateY(-50%); background:rgba(0,0,0,0.6); color:white; border:none; border-radius:50%; width:40px; height:40px; cursor:pointer; font-size:20px;">&#10094;</button>

        <!-- Next Button -->
        <button onclick="showNextImage()" 
                style="position:absolute; top:50%; right:15px; transform:translateY(-50%); background:rgba(0,0,0,0.6); color:white; border:none; border-radius:50%; width:40px; height:40px; cursor:pointer; font-size:20px;">&#10095;</button>
      </div>
    <% end %>

    <!-- Thumbnails -->
    <% if @car.images.attached? && @car.images.count > 1 %>
      <div style="display:flex; gap:10px; margin-top:12px; overflow-x:auto; padding-bottom:8px;">
        <% @car.images.each_with_index do |img, index| %>
          <% big_url   = url_for(img.variant(resize_to_limit: [1600, 1600])) %>
          <% thumb_url = url_for(img.variant(resize_to_limit: [150, 150])) %>
          <%= image_tag thumb_url,
              onclick: "showImageAtIndex(#{index})",
              data: { big_url: big_url },
              style:"width:70px; height:70px; object-fit:cover; border-radius:8px; border:2px solid #ccc; cursor:pointer; transition:0.3s;" %>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- RIGHT: Details -->
  <div style="flex:1 1 35%; min-width:300px; display:flex; flex-direction:column; gap:12px; font-size:16px;">
    <p><strong>Category:</strong> <%= @car.category.presence || "Not specified" %></p>

    <p><strong>Price:</strong> 
      <% if @car.for_rent? %>
        <span style="font-size:20px; font-weight:600; color:#111;">KES <%= number_to_currency(@car.price, unit: '') %> /day</span>
      <% elsif @car.for_sale? %>
        <span style="font-size:20px; font-weight:600; color:#111;">KES <%= number_to_currency(@car.price, unit: '') %></span>
      <% else %>
        Not listed
      <% end %>
    </p>

    <div>
      <h3 style="font-weight:600; margin-bottom:4px;">Owner Contact</h3>
      <p>Email: <%= @car.owner.email %></p>
      <p>Phone: <%= @car.owner.phone_number %></p>
    </div>

    <p><strong>Deposit Amount:</strong> KES <%= number_with_precision(@car.deposit_amount, precision:2, delimiter:",") %></p>

<% if user_signed_in? && current_user == @car.owner %>
  <!-- Owner: Disabled Button -->
  <a style="display:inline-block; margin-top:10px; background:#9ca3af; color:white; padding:12px 20px; border-radius:10px; font-weight:600; text-decoration:none; cursor:not-allowed; opacity:0.7;">Book this car</a>
<% else %>
  <!-- All others: Enabled -->
  <button onclick="openBookingModal()" 
          style="display:inline-block; margin-top:10px; background:#2563eb; color:white; padding:12px 20px; border-radius:10px; font-weight:600; text-decoration:none; transition:0.3s; cursor:pointer;">
    Book this car
  </button>
<% end %>

<!-- Booking Modal -->
<div id="bookingModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
  <div id="bookingModalContent" style="background:white; padding:20px; border-radius:12px; max-width:700px; width:90%; max-height:90vh; overflow-y:auto;">
    <!-- Booking form or confirmation will be loaded here -->
  </div>
</div>

<script>
function openBookingModal() {
  document.getElementById("bookingModal").style.display = "flex";
  fetch("<%= new_car_booking_path(@car) %>", { headers: { "Turbo-Frame": "bookingModalContent" } })
    .then(response => response.text())
    .then(html => { document.getElementById("bookingModalContent").innerHTML = html; });
}

function closeBookingModal() {
  document.getElementById("bookingModal").style.display = "none";
}
</script>

  </div>
</div>

<!-- Description -->
<div style="margin-top:30px;">
  <h3 style="font-weight:600;">Description</h3>
  <p><%= @car.description.presence || "No description provided." %></p>
</div>

<!-- Map -->
<div style="margin-top:40px;">
  <h2 style="font-size:20px; font-weight:600; margin-bottom:10px;">Pickup Location</h2>
  <% if @car.latitude.present? && @car.longitude.present? %>
    <div id="map" style="height:300px; border-radius:12px; overflow:hidden;"></div>
    <script>
      function initCarMap() {
        var lat = <%= @car.latitude %>;
        var lng = <%= @car.longitude %>;
        var map = L.map('map').setView([lat, lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        L.marker([lat, lng]).addTo(map)
          .bindPopup("<%= j(@car.pickup_address.presence || 'Pickup Location') %>")
          .openPopup();
      }
      document.addEventListener("turbo:load", initCarMap);
      document.addEventListener("DOMContentLoaded", initCarMap);
    </script>
  <% else %>
    <p>No pickup location set for this car.</p>
  <% end %>
</div>

<!-- Reviews -->
<div style="margin-top:40px;">
  <h2 style="font-size:20px; font-weight:600; margin-bottom:10px;">Reviews</h2>
  <% @car.reviews.each do |review| %>
    <div style="border:1px solid #ddd; border-radius:8px; padding:12px; margin-bottom:10px;">
      <strong><%= review.user.email %></strong>
      <!-- Show stars -->
      <div>
        <% 5.times do |i| %>
          <% if i < review.rating %>
            <span style="color:#f5a623; font-size:18px;">&#9733;</span>
          <% else %>
            <span style="color:#ddd; font-size:18px;">&#9733;</span>
          <% end %>
        <% end %>
      </div>
      <p><%= review.comment %></p>
    </div>
  <% end %>

  <% if user_signed_in? %>
    <%= form_with(model:[@car, Review.new], local:true, style:"margin-top:15px; display:flex; flex-direction:column; gap:10px;") do |form| %>
      <div>
        <%= form.label :rating %><br>
        <div id="starRating" style="display:flex; gap:5px; cursor:pointer;">
          <% 5.times do |i| %>
            <span class="star" data-value="<%= i+1 %>" style="font-size:24px; color:#ddd;">&#9733;</span>
          <% end %>
        </div>
        <%= form.hidden_field :rating, id:"ratingInput" %>
      </div>
      <div>
        <%= form.label :comment %>
        <%= form.text_area :comment, style:"width:100%; min-height:80px;" %>
      </div>
      <%= form.submit "Submit Review", style:"background:#2563eb; color:white; padding:10px 18px; border-radius:8px; font-weight:600; cursor:pointer; border:none;" %>
    <% end %>
  <% end %>
</div>

<%= link_to "Back to cars", cars_path, style:"display:inline-block; margin-top:30px; background:#f3f4f6; padding:10px 18px; border-radius:8px; font-weight:500; text-decoration:none; color:#111;" %>

<script>
  document.addEventListener("turbo:load", () => {
    const thumbs = document.querySelectorAll('[data-big-url]');
    window.imageUrls = Array.from(thumbs).map(el => el.dataset.bigUrl);
    window.currentIndex = 0;
    if (imageUrls.length > 0) {
      document.getElementById('mainImage').src = imageUrls[0];
    }

    // Rating stars
    const stars = document.querySelectorAll("#starRating .star");
    const ratingInput = document.getElementById("ratingInput");
    stars.forEach(star => {
      star.addEventListener("click", () => {
        const value = star.dataset.value;
        ratingInput.value = value;
        stars.forEach(s => s.style.color = "#ddd");
        for (let i = 0; i < value; i++) {
          stars[i].style.color = "#f5a623";
        }
      });
    });
  });

  function showImageAtIndex(index) {
    if (!imageUrls || imageUrls.length === 0) return;
    currentIndex = index;
    document.getElementById('mainImage').src = imageUrls[currentIndex];
  }
  function showNextImage() {
    if (!imageUrls || imageUrls.length === 0) return;
    currentIndex = (currentIndex + 1) % imageUrls.length;
    document.getElementById('mainImage').src = imageUrls[currentIndex];
  }
  function showPrevImage() {
    if (!imageUrls || imageUrls.length === 0) return;
    currentIndex = (currentIndex - 1 + imageUrls.length) % imageUrls.length;
    document.getElementById('mainImage').src = imageUrls[currentIndex];
  }
</script>
